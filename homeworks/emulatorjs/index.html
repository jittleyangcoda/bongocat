<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>basically something for school</title>
  <style>
    body {
      background: #0e0e0e;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    select,
    input,
    button {
      margin: 10px;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    select,
    input {
      background-color: #1f1f1f;
      color: white;
    }

    button {
      background-color: #0078ff;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #005fcc;
    }

    #emulator {
      width: 80%;
      max-width: 900px;
      height: 600px;
      margin: 20px auto;
      background: black;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #emulator iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
  <script src="https://raw.githubusercontent.com/jittleyangcoda/bongocat/refs/heads/main/script.js"></script>
</head>

<body>
  <h1>ðŸŽ® EmulatorJS (modified by chatgpt)</h1>
  <p>Select your console, upload your ROM, and click Load!</p>

  <!-- Console Selector -->
  <select id="consoleSelect">
    <optgroup label="Nintendo">
      <option value="nes">Famicom / NES</option>
      <option value="gba">Game Boy Advance</option>
      <option value="gb">Game Boy</option>
      <option value="snes">SNES</option>
      <option value="nds">DS</option>
      <option value="n64">Nintendo 64</option>
      <option value="virtualboy">Virtual Boy</option>
    </optgroup>

    <optgroup label="Sega">
      <option value="sms">Master System</option>
      <option value="megadrive">Mega Drive / Genesis</option>
      <option value="gamegear">Game Gear</option>
      <option value="saturn">Saturn</option>
      <option value="sega32x">32X</option>
      <option value="segacd">Sega CD</option>
    </optgroup>

    <optgroup label="Atari">
      <option value="atari2600">Atari 2600</option>
      <option value="atari5200">Atari 5200</option>
      <option value="atari7800">Atari 7800</option>
      <option value="lynx">Lynx</option>
      <option value="jaguar">Jaguar</option>
    </optgroup>

    <optgroup label="Commodore">
      <option value="c64">Commodore 64</option>
      <option value="c128">Commodore 128</option>
      <option value="amiga">Amiga</option>
      <option value="pet">PET</option>
      <option value="plus4">Plus/4</option>
      <option value="vic20">VIC-20</option>
    </optgroup>

    <optgroup label="Other">
      <option value="psx">PlayStation</option>
      <option value="psp">PlayStation Portable</option>
      <option value="arcade">Arcade</option>
      <option value="3do">3DO</option>
      <option value="mame2003">MAME 2003</option>
      <option value="coleco">ColecoVision</option>
    </optgroup>
  </select>

  <!-- ROM File Input -->
  <input type="file" id="romInput" accept=".nes,.smc,.sfc,.gba,.gb,.gbc,.zip,.bin,.iso,.rom,.img" />

  <!-- Load Button -->
  <button id="loadBtn">Load</button>

  <!-- Emulator Container -->
  <div id="emulator"></div>
  <!-- put this in your page where you currently set EJS_player/EJS_core and load loader.js -->
  <script>
    /* ----- helpers ----- */
    function safeKey(name) {
      return 'ejs_save_' + encodeURIComponent(name);
    }

    // Convert ArrayBuffer -> base64 (safe for large buffers by chunking)
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      const chunkSize = 0x8000; // 32KB chunks
      let binary = '';
      for (let i = 0; i < bytes.length; i += chunkSize) {
        const sub = bytes.subarray(i, i + chunkSize);
        binary += String.fromCharCode.apply(null, sub);
      }
      return btoa(binary);
    }

    function base64ToDataUrl(b64, mime = 'application/octet-stream') {
      return `data:${mime};base64,${b64}`;
    }

    /* ----- When saving: catch emulator save updates ----- */
    /* This function will be set before loader.js is appended so the running emulator
       calls it when a save file has changed. EJS_onSaveUpdate receives:
       { hash, save (ArrayBuffer), screenshot, format }
    */
    window.EJS_onSaveUpdate = function (info) {
      try {
        if (!info || !info.save) return;
        // choose a key - prefer gameName if present, fallback to gameUrl
        // EmulatorJS will provide names; if you're the uploader use the uploaded filename
        const gameId = (window.EJS_gameName || window.EJS_gameUrl || 'unknown-game');
        const key = safeKey(gameId);
        const b64 = arrayBufferToBase64(info.save);
        // Save base64 string to localStorage
        localStorage.setItem(key, b64);
        console.log('[EJS] saved to localStorage key=', key, ' bytes=', info.save.byteLength);
      } catch (err) {
        console.warn('[EJS] save persist failed', err);
      }
    };

    /* ----- Before launching emulator: mount saved file if present ----- */
    /* Call this right before you dynamically create loader.js (or before including it statically) */
    async function prepareSavedFilesForLaunch(gameNameOrUrl, expectedSaveFilename) {
      // expectedSaveFilename should be the file name EmulatorJS will look for,
      // e.g. "Super Mario World.srm" or "game.srm" depending on the core.
      const key = safeKey(gameNameOrUrl);
      const b64 = localStorage.getItem(key);
      if (!b64) return null;

      // create a data URL and instruct loader to extract it into /data/saves/
      // EJS_externalFiles maps a path in the EJS FS -> URL
      const dataUrl = base64ToDataUrl(b64);
      // mount path inside emulator FS. Example target path '/data/saves/<filename>'
      const mountPath = '/data/saves/' + expectedSaveFilename;
      window.EJS_externalFiles = {};
      window.EJS_externalFiles[mountPath] = dataUrl;

      console.log('[EJS] found local save, will mount at', mountPath);
      return mountPath;
    }

    /* ----- Example integration with your Load button handler ----- */
    let selectedCore = null;
    let selectedFile = null;

    document.getElementById("consoleSelect").addEventListener("change", (e) => {
      selectedCore = e.target.value;
    });

    document.getElementById("romInput").addEventListener("change", (e) => {
      selectedFile = e.target.files[0];
    });

    document.getElementById("loadBtn").addEventListener("click", async () => {
      if (!selectedCore) {
        alert("Please select a console!");
        return;
      }
      if (!selectedFile) {
        alert("Please select a ROM file!");
        return;
      }

      // Convert file to Blob URL
      const arrayBuffer = await selectedFile.arrayBuffer();
      const blob = new Blob([arrayBuffer]);
      const blobUrl = URL.createObjectURL(blob);
      window.EJS_player = "#emulator";
      window.EJS_gameUrl = blobUrl;
      window.EJS_core = selectedCore;
      window.EJS_pathtodata = "https://calm-moon-9ca7.ilikechez87.workers.dev/stable/data/";

      // Optional: force periodic flush from core to save files every 7s
      window.EJS_fixedSaveInterval = 7000; // milliseconds -- adjust as needed

      // Prepare a name for the save file that the core will expect:
      // choose a sane default: uploaded filename with .srm extension
      const baseFileName = selectedFile.name.replace(/\.[^/.]+$/, ""); // strip ext
      const saveFileName = baseFileName + ".srm";

      // If a save exists in localStorage, mount it so the core finds it on boot.
      await prepareSavedFilesForLaunch(window.EJS_gameUrl || baseFileName, saveFileName);

      // Clean emulator container for reloads
      document.getElementById("emulator").innerHTML = "";

      // Now inject loader.js (it will read the globals above and mount external files)
      const script = document.createElement("script");
      script.src = "https://calm-moon-9ca7.ilikechez87.workers.dev/stable/data/loader.js";
      document.body.appendChild(script);
    });
  </script>
</body>
</html>